{{ define "main" }}
<main class="book-page">
  <article class="markdown">

    {{/* === published 配下の index.md（各フォルダのトップ）だけを堅牢に収集 === */}}
    {{ $pages := slice }}
    {{ range site.RegularPages }}
        {{/* ファイル名が index のページのみ抽出（published 限定を撤廃） */}}
        {{ if eq .File.BaseFileName "index" }}
        {{ $pages = $pages | append . }}
      {{ end }}
    {{ end }}

    {{/* 0件なら空メッセージ（デバッグ用に一時表示） */}}
    {{ if eq (len $pages) 0 }}
      <div class="book-hint info" style="margin-bottom:1rem">
        <strong>No entries found.</strong>
        <div style="opacity:.8">
          Check:
          <ul>
            <li><code>content/published/**/index.md</code> の <code>draft</code> が <code>false</code>（または未指定）か</li>
            <li>ビルド時に <code>hugo -D</code> を使っていない（ドラフト除外）か</li>
            <li><code>config.toml</code> の <code>ignoreFiles</code> に <code>published</code> を誤って含めていないか</li>
            <li>各 <code>index.md</code> に最低限 <code>title:</code> があるか（なくても出ますが並び替えに影響）</li>
          </ul>
        </div>
      </div>
    {{ end }}

{{/* === タグ収集（MixItUp ボタン自動生成） === */}}
    {{ $tags := slice }}
    {{ $tagNameMap := dict }} 

    {{ range $pages }}
      {{ with .Params.tags }}
        {{ range . }}
          {{ $originalName := . }}
          {{/* ▼▼▼ 修正: urlize ではなく md5 を使い、安全な英数字IDを生成 ▼▼▼ */}}
          {{ $id := printf "tag-%s" (md5 $originalName) }}
          
          {{ if not (in $tags $id) }}
            {{ $tags = $tags | append $id }}
            {{ $tagNameMap = merge $tagNameMap (dict $id $originalName) }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    <!-- ===== 検索ボックス（filter の上） ===== -->
<button type="button" id="controls-toggle-btn" class="controls-toggle-btn">
      <span class="btn-icon">▼</span>
    </button>

    <div id="controls-wrapper" class="controls-wrapper">
      <div class="controls-inner">
        
        <div class="search-bar">
          <label for="search-input">search :</label>
          <input type="text" id="search-input" placeholder="type to filter..." />
        </div>

        <div class="controls-vertical">
          <div class="controls-row">
            <span class="controls-label">tags :</span>
            <div class="and-filter-group">
              <button class="is-checked" data-tag="all">all</button>
              {{ range sort $tags }}
                <button data-tag=".{{ . }}">{{ index $tagNameMap . }}</button>
              {{ end }}
            </div>
          </div>

          <div class="controls-row">
            <span class="controls-label">sort :</span>
            <div class="and-sort-group">
              <button class="is-checked" data-sort="date:desc">newest</button>
              <button data-sort="date:asc">oldest</button>
              <button data-sort="title:asc">a-z</button>
              <button data-sort="title:desc">z-a</button>
            </div>
          </div>

          <div class="controls-row">
            <span class="controls-label">view :</span>
            <div class="and-view-group">
              <button class="is-checked" data-view="icons">icons</button>
              <button data-view="details">details</button>
              <button data-view="content">content</button>
            </div>
          </div>
        </div>

        <div class="controls-row slider-row" id="column-slider-container">
          <span class="controls-label">scale :</span>
          <input type="range" id="column-slider" min="1" max="10" value="3" step="1" style="flex: 1; max-width: 200px;">
          <span id="column-value" style="min-width: 1.5rem; font-weight: bold; margin-left: 0.5rem;">3</span>
        </div>

      </div></div>

    <!-- ===== グリッド（Hugoでタイトル昇順に出力） ===== -->
    <div class="grid view--icons">
      {{ range sort $pages "Title" "asc" }}
        {{ $classes := slice }}
        {{ with .Params.tags }}
        {{ range . }}
        {{ $classes = $classes | append (printf "tag-%s" (md5 .)) }}
        {{ end }}{{ end }}
        <a class="grid-item {{ delimit $classes " " }}" href="{{ .RelPermalink }}"
           data-title="{{ lower .Title }}"
           data-date="{{ .Date.Format "20060102" }}"

             {{ with .Params.color }}style="--card-color: {{ . }};"{{ end }}>

          <div class="card">

            {{/* cover_ から始まる画像を1枚取得（png/jpg/jpeg等は Resources.ByType "image" が吸収） */}}
            {{ $cover := index (.Resources.Match "cover_*") 0 }}

            {{ if $cover }}
              <div class="card-bg"
                  style="background-image: url('{{ $cover.RelPermalink }}');">
              </div>

            {{ else if .Params.color }}
              <div class="card-bg is-color"
                  style="background-color: {{ .Params.color }};">
              </div>
            {{ end }}

            <div class="card-inner">
  
              <div class="card-main-col">
                <div class="title">{{ .Title }}</div>

                <div class="card-tags">
                  {{ with .Params.tags }}
                    {{ range . }}
                      <span class="tag-pill">#{{ . }}</span>
                    {{ end }}
                  {{ end }}
                </div>
              </div>
              <div class="meta">{{ .Date.Format "2006-01-02" }}</div>
              <div class="excerpt">{{ with .Summary }}{{ . }}{{ end }}</div>
            </div>
          </div>
        </a>
      {{ end }}
    </div>

    <!-- ===== 初期化（検索=クラス付与方式 / タグOR / ソート / ビュー / URL初期フィルタ） ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (!window.mixitup) { console.warn('mixitup not found'); return; }

  const grid        = document.querySelector('.grid');
  const filterGroup = document.querySelector('.and-filter-group');
  const sortGroup   = document.querySelector('.and-sort-group');
  const viewGroup   = document.querySelector('.and-view-group');
  const searchInput = document.querySelector('#search-input');

  if (!grid) return;

  // MixItUp初期化
  const mixer = mixitup(grid, {
    selectors: { target: '.grid-item' },
    animation: { duration: 280, queueLimit: 10, effects: 'fade translateZ(-1px)' },
    // data-filter属性を使わないため、controls設定はデフォルトのままでOKですが
    // 念のため自動バインドを無効化しておきます
    controls: { scope: 'local' } 
  });

// --- 0. コントロール開閉制御（追加） ---
  const toggleBtn = document.getElementById('controls-toggle-btn');
  const wrapper = document.getElementById('controls-wrapper');

  if (toggleBtn && wrapper) {
    toggleBtn.addEventListener('click', () => {
      const isClosed = wrapper.classList.toggle('is-closed');
      toggleBtn.classList.toggle('is-closed', isClosed);
    });
  }

  let searchQuery = '';

  // --- 1. フィルタリング実行関数 ---
  function applyFilter() {
    // 1. 検索ワードによるクラス付与（.__match）
    const q = searchQuery.toLowerCase().trim();
    const items = grid.querySelectorAll('.grid-item');
    
    // 検索語がある場合のみマッチ判定を行う
    if (q) {
      items.forEach(el => {
        const text = el.textContent.toLowerCase();
        // data-title属性も検索対象に含めると精度が上がります
        const title = el.getAttribute('data-title') || ''; 
        if (text.includes(q) || title.includes(q)) {
          el.classList.add('__match');
        } else {
          el.classList.remove('__match');
        }
      });
    } else {
      // 検索語がない場合は全員マッチ扱い（クラスはつけないが、ロジックで対応）
      items.forEach(el => el.classList.remove('__match'));
    }

    // 2. 選択されたタグの収集
    const checkedBtns = Array.from(filterGroup.querySelectorAll('.is-checked'));
    const selectedTags = checkedBtns
      .map(btn => btn.getAttribute('data-tag'))
      .filter(tag => tag !== 'all'); // "all" は除外

    // 3. セレクタの構築
    let selector = '';

    if (selectedTags.length === 0) {
      // タグ未選択（またはAll）の場合
      selector = q ? '.__match' : 'all';
    } else {
      // タグ選択ありの場合（OR検索: .tagA, .tagB）
      // 検索語があるなら (.tagA.__match, .tagB.__match) にする
      if (q) {
        selector = selectedTags.map(tag => `${tag}.__match`).join(', ');
      } else {
        selector = selectedTags.join(', ');
      }
    }

    // console.log("Filter:", selector); // デバッグ用
    mixer.filter(selector);
  }

// --- 2. URLパラメータ読み込み ---
  (function fromURL(){
    const params = new URLSearchParams(window.location.search);
    const filterParam = params.get('filter');
    if (filterParam) {
      const tags = filterParam.split(',').map(s => s.trim()).filter(Boolean);
      
      if (filterGroup && tags.length > 0) {
        // Allを外す
        filterGroup.querySelector('[data-tag="all"]')?.classList.remove('is-checked');
        
        tags.forEach(tagName => {
          // ▼▼▼ 修正: クラス名ではなく、ボタンのテキスト(日本語)で探す ▼▼▼
          // ボタン一覧を取得し、テキストが一致するものを探してONにする
          const buttons = Array.from(filterGroup.querySelectorAll('button[data-tag]'));
          const targetBtn = buttons.find(btn => btn.textContent.trim() === tagName);
          
          if (targetBtn) {
            targetBtn.classList.add('is-checked');
          }
        });
      }
    }
  })();

  // --- 3. タグボタンのクリック制御 ---
  if (filterGroup) {
    filterGroup.addEventListener('click', (e) => {
      // data-tag を持つ要素を探す（data-filterではない）
      const btn = e.target.closest('[data-tag]');
      if (!btn) return;
      e.preventDefault();
      
      const tag = btn.getAttribute('data-tag');

      if (tag === 'all') {
        // Allをクリック：他を全解除して自分だけON
        filterGroup.querySelectorAll('.is-checked').forEach(el => el.classList.remove('is-checked'));
        btn.classList.add('is-checked');
      } else {
        // 個別タグをクリック：トグル動作
        btn.classList.toggle('is-checked');
        
        // Allのチェックを外す
        filterGroup.querySelector('[data-tag="all"]')?.classList.remove('is-checked');

        // もし全部オフになったらAllを復活させる
        if (filterGroup.querySelectorAll('.is-checked').length === 0) {
          filterGroup.querySelector('[data-tag="all"]')?.classList.add('is-checked');
        }
      }
      applyFilter();
    });
  }

  // --- 4. 検索入力 ---
  let debounceTimer;
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        searchQuery = searchInput.value;
        applyFilter();
      }, 150);
    });
  }

// --- 4.5 ソートボタン制御（追加） ---
  if (sortGroup) {
    sortGroup.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-sort]');
      if (!btn) return;

      // チェック状態の更新
      sortGroup.querySelectorAll('.is-checked').forEach(el => el.classList.remove('is-checked'));
      btn.classList.add('is-checked');

      // MixItUpのソート実行
      const sortCommand = btn.getAttribute('data-sort');
      mixer.sort(sortCommand);
    });
  }

// --- 5. ソートとビュー ---
  if (viewGroup) {
    viewGroup.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-view]');
      if (!btn) return;

      // チェック状態の更新
      viewGroup.querySelectorAll('.is-checked').forEach(el => el.classList.remove('is-checked'));
      btn.classList.add('is-checked');

      // ビューの切り替え
      const view = btn.getAttribute('data-view');
      grid.classList.remove('view--icons','view--details','view--content');
      grid.classList.add(`view--${view}`);

      // 【追加】スライダーの表示制御
      if (view === 'icons') {
        sliderContainer.style.display = 'flex';
      } else {
        sliderContainer.style.display = 'none';
      }

      mixer.forceRefresh();
    });
  }

// --- 6. カラム数スライダー制御 ---
const columnSlider = document.querySelector('#column-slider');
const columnValue = document.querySelector('#column-value');
const sliderContainer = document.querySelector('#column-slider-container');

function updateColumns(val) {
  grid.style.setProperty('--col-count', val);
  columnValue.textContent = val;
  columnSlider.value = val; // スライダーのつまみの位置も同期
}

// デバイスサイズに基づいて初期値を決定する関数
function getInitialColumns() {
  if (window.innerWidth < 640) {
    return 2; // スマホは2列
  } else if (window.innerWidth < 1024) {
    return 4; // タブレットは4列
  } else {
    return 6; // PCは6列
  }
}

if (columnSlider) {
  // 1. ページ読み込み時にデバイスに合わせた初期値をセット
  const initialVal = getInitialColumns();
  updateColumns(initialVal);

  // 2. スライダー操作時のイベント
  columnSlider.addEventListener('input', (e) => {
    updateColumns(e.target.value);
  });
}

// view切り替え時にスライダーの表示/非表示を制御する（既存のviewGroupイベントに追加）
if (viewGroup) {
  viewGroup.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-view]');
    if (!btn) return;
    
    const view = btn.getAttribute('data-view');
    // Iconsビューの時だけスライダーを表示
    if (view === 'icons') {
      sliderContainer.style.display = 'flex';
    } else {
      sliderContainer.style.display = 'none';
    }
    
    // ...既存の処理（is-checkedの付け替えやgridのクラス付与など）...
  });
}

// 初期化時に一度実行
updateColumns(columnSlider.value);

  // 初期実行
  applyFilter();
});
</script>

  </article>
</main>
{{ end }}
