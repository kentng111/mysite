{{ define "main" }}
<main class="book-page">
  <article class="markdown">

    {{ $pages := slice }}
    {{ range site.RegularPages }}
        {{ if eq .File.BaseFileName "index" }}
        {{ $pages = $pages | append . }}
      {{ end }}
    {{ end }}

    {{ if eq (len $pages) 0 }}
      <div class="book-hint info" style="margin-bottom:1rem">
        <strong>No entries found.</strong>
        <div style="opacity:.8">
          Check:
          <ul>
            <li><code>content/published/**/index.md</code> の <code>draft</code> が <code>false</code>（または未指定）か</li>
            <li>ビルド時に <code>hugo -D</code> を使っていない（ドラフト除外）か</li>
            <li><code>config.toml</code> の <code>ignoreFiles</code> に <code>published</code> を誤って含めていないか</li>
            <li>各 <code>index.md</code> に最低限 <code>title:</code> があるか（なくても出ますが並び替えに影響）</li>
          </ul>
        </div>
      </div>
    {{ end }}

    {{ $tags := slice }}
    {{ $tagNameMap := dict }} 

    {{ range $pages }}
      {{ with .Params.tags }}
        {{ range . }}
          {{ $originalName := . }}
          {{ $id := printf "tag-%s" (md5 $originalName) }}
          
          {{ if not (in $tags $id) }}
            {{ $tags = $tags | append $id }}
            {{ $tagNameMap = merge $tagNameMap (dict $id $originalName) }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    <button type="button" id="controls-toggle-btn" class="controls-toggle-btn">
      <span class="btn-icon">▼</span>
    </button>

    <div id="controls-wrapper" class="controls-wrapper">
      <div class="controls-inner">
        
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="search..." />
        </div>

        <div class="controls-vertical">
          
          <div class="controlsfv-row">
            <div class="and-view-group">
              <button class="is-checked" data-view="icons" aria-label="Icons view">
                <img src="/img/view-button_1.svg" alt="" class="view-img">
              </button>
              
              <button data-view="content" aria-label="Content view">
                <img src="/img/view-button_3.svg" alt="" class="view-img">
              </button>

              <button data-view="details" aria-label="Details view">
                <img src="/img/view-button_2.svg" alt="" class="view-img">
              </button>
            </div>

          <div class="controls-row">
            <div class="and-filter-group">
              <button type="button" class="is-checked" data-filter="all">ALL</button>
                {{ range sort $tags }}
                  <button type="button" data-filter=".{{ . }}">{{ index $tagNameMap . }}</button>
                {{ end }}
            </div>
          </div>

          <div class="controls-divider"></div>
          <div class="controls-row slider-row" id="column-slider-container">
            <input type="range" id="column-slider" min="1" max="10" value="8" step="1" style="flex: 1; max-width: 350px;">
          </div>

          <div class="controls-row display-options-row" id="display-options-container" style="padding-bottom: 0.5rem;">
            
            <div class="display-option-item">
              <button type="button" class="display-dot-btn is-checked" data-target="image">image</button>
              <button type="button" class="img-fit-btn" id="img-fit-toggle" data-state="cover">[ ]</button>
            </div>

            <div class="display-option-item">
                <button type="button" class="display-dot-btn" data-target="index">index</button>
                <button type="button" class="sort-btn" data-sort="index" data-dir="asc">∧</button>
            </div>

            <div class="display-option-item">
              <button type="button" class="display-dot-btn" data-target="year">year</button>
              <button type="button" class="sort-btn" data-sort="year" data-dir="default">-</button>
            </div>

            <div class="display-option-item">
              <button type="button" class="display-dot-btn is-checked" data-target="title">title</button>
              <button type="button" class="sort-btn" data-sort="title" data-dir="default">-</button>
            </div>

            <div class="display-option-item">
              <button type="button" class="display-dot-btn" data-target="tag">tag</button>
              <div class="sort-btn" style="cursor: default; opacity: 0;">&nbsp;</div>
            </div>

          </div>
          
        </div> </div> </div> </div>




      <div class="grid view--icons">

          <div class="details-controls">
            <span class="d-control" data-target="color">color</span> / 
            <span class="d-control" data-target="index">index</span> / 
            <span class="d-control" data-target="year">year</span> / 
            <span class="d-control" data-target="tag">tag</span>
          </div>

          <div class="grid-header-row">
              <div class="header-index" data-sort="index"><span class="sort-arrow"></span>#</div>
              <div class="header-year" data-sort="year"><span class="sort-arrow"></span>year</div>
              <div class="header-title" data-sort="title"><span class="sort-arrow"></span>title</div>
              <div class="header-tag" data-sort="tag"><span class="sort-arrow"></span>tag</div>
          </div>

        {{ range sort $pages "Title" "asc" }}
          {{ $classes := slice }}
          {{ with .Params.tags }}{{ range . }}{{ $classes = $classes | append (printf "tag-%s" (md5 .)) }}{{ end }}{{ end }}
            <a class="grid-item fv {{ delimit $classes " " }}" href="{{ .RelPermalink }}"
                data-title="{{ lower .Title }}"
                data-year="{{ .Params.year }}" 
                data-index="{{ .Params.index | default 0 }}"
                data-tag="{{ with .Params.tags }}{{ index (sort .) 0 }}{{ end }}"
                {{ with .Params.color }}style="--card-color: {{ . }};"{{ end }}>

            <div class="card">
              {{ $cover := index (.Resources.Match "cover_*") 0 }}
              {{ if $cover }}
                <div class="card-bg" style="background-image: url('{{ $cover.RelPermalink }}');"></div>
              {{ else if .Params.color }}
                <div class="card-bg is-color" style="background-color: {{ .Params.color | safeCSS }};"></div>
              {{ end }}

              <div class="card-inner">
                <div class="card-main-col">
                  <div class="index-number">{{ .Params.index }}</div>
                  <div class="meta">{{ .Params.year }}</div> <div class="title">{{ .Title }}</div>
                  <div class="card-tags">
                    {{ with .Params.tags }}
                      {{ range sort . "value" "asc" }}
                        <span class="tag-pill">{{ . }}</span>
                      {{ end }}
                    {{ end }}
                  </div>
                </div>
                <div class="excerpt">{{ with .Summary }}{{ . }}{{ end }}</div>
              </div>
            </div>
          </a>
        {{ end }}
      </div>

    <script>
    //nnn JavaScriptメイン処理
document.addEventListener('DOMContentLoaded', function () {
      if (!window.mixitup) { console.warn('mixitup not found'); return; }

      const grid        = document.querySelector('.grid');
      const filterGroup = document.querySelector('.and-filter-group');
      const viewGroup   = document.querySelector('.and-view-group');
      const searchInput = document.querySelector('#search-input');
      const sliderContainer = document.querySelector('#column-slider-container');
      const displayOptionsContainer = document.querySelector('#display-options-container');

      if (!grid) return;

      //nnn MixItUp初期化
      const mixer = mixitup(grid, {
        selectors: { target: '.grid-item' },
        animation: { duration: 280, queueLimit: 10, effects: 'fade translateZ(-1px)' },
        controls: { scope: 'local' },
        load: { sort: 'index:asc' }
      });

      //nnn コントロール開閉制御
      const toggleBtn = document.getElementById('controls-toggle-btn');
      const wrapper = document.getElementById('controls-wrapper');
      if (toggleBtn && wrapper) {
        toggleBtn.addEventListener('click', () => {
          const isClosed = wrapper.classList.toggle('is-closed');
          toggleBtn.classList.toggle('is-closed', isClosed);
        });
      }

      //nnn検索入力のイベントリスナー
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value; // 入力された値を保持
          applyFilter();                // フィルタリング処理を実行
        });
      }
      // ------------------------------------------

      //nnn フィルター適用ロジック
      let searchQuery = '';
      function applyFilter() {
        const q = searchQuery.toLowerCase().trim();
        const items = grid.querySelectorAll('.grid-item');
        if (q) {
          items.forEach(el => {
            const text = el.textContent.toLowerCase();
            const title = el.getAttribute('data-title') || ''; 
            if (text.includes(q) || title.includes(q)) el.classList.add('__match');
            else el.classList.remove('__match');
          });
        } else {
          items.forEach(el => el.classList.remove('__match'));
        }
        const checkedBtns = Array.from(filterGroup.querySelectorAll('.is-checked'));
          const selectedFilters = checkedBtns
            .map(btn => btn.getAttribute('data-filter')) // ★ data-filter を読む
            .filter(f => f && f !== 'all');              // ★ null/空 & all を除外
          let selector = '';
          if (selectedFilters.length === 0) {
            selector = q ? '.__match' : 'all';
          } else {
            selector = q
              ? selectedFilters.map(f => `${f}.__match`).join(', ')
              : selectedFilters.join(', ');
          }
          mixer.filter(selector);
        }

      //nnn タグフィルタクリック処理
      if (filterGroup) {
          filterGroup.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-filter]');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation(); // ★ MixItUp の data-filter 自動制御と競合しにくくする

            const filter = btn.getAttribute('data-filter');

            if (filter === 'all') {
              filterGroup.querySelectorAll('.is-checked').forEach(el => el.classList.remove('is-checked'));
              btn.classList.add('is-checked');
            } else {
              btn.classList.toggle('is-checked');
              filterGroup.querySelector('button[data-filter="all"]')?.classList.remove('is-checked');

              if (filterGroup.querySelectorAll('.is-checked').length === 0) {
                filterGroup.querySelector('button[data-filter="all"]')?.classList.add('is-checked');
              }
            }

            applyFilter();
          });

      }

      //nnn 表示形式切替と条件付き表示制御
      if (viewGroup) {
        viewGroup.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-view]');
          if (!btn) return;

          viewGroup.querySelectorAll('.is-checked').forEach(el => el.classList.remove('is-checked'));
          btn.classList.add('is-checked');

          const view = btn.getAttribute('data-view');
          grid.classList.remove('view--icons','view--details','view--content');
          grid.classList.add(`view--${view}`);

          if (view === 'icons') {
            sliderContainer.style.display = 'flex';
            displayOptionsContainer.style.display = 'flex';
          } else {
            sliderContainer.style.display = 'none';
            displayOptionsContainer.style.display = 'none';
          }

          mixer.forceRefresh();
        });
      }

      //nnn カラム数スライダー制御
      const columnSlider = document.querySelector('#column-slider');

      function updateColumns(val) {
        const displayCol = 11 - parseInt(val);
        grid.style.setProperty('--col-count', displayCol);
        columnSlider.value = val;
      }

      function getInitialColumns() {
        let cols;
        if (window.innerWidth < 640) cols = 2;
        else if (window.innerWidth < 1024) cols = 4;
        else cols = 6;
        
        return 11 - cols;
      }

      if (columnSlider) {
        updateColumns(getInitialColumns());
        
        columnSlider.addEventListener('input', (e) => {
          updateColumns(e.target.value);
        });
      }

      //nnn 表示オプションボタン群の取得
      const displayBtns = document.querySelectorAll('.display-dot-btn');
      const imgFitBtn = document.getElementById('img-fit-toggle');

      //nnn 画像フィット切替ボタン制御
      if (imgFitBtn) {
        imgFitBtn.addEventListener('click', (e) => {
          e.stopPropagation();

          const currentState = imgFitBtn.getAttribute('data-state');
          
          if (currentState === 'cover') {
            imgFitBtn.setAttribute('data-state', 'fit');
            imgFitBtn.textContent = '< >';
            grid.classList.add('is-fit');
          } else {
            imgFitBtn.setAttribute('data-state', 'cover');
            imgFitBtn.textContent = '[ ]';
            grid.classList.remove('is-fit');
          }
        });
      }

      //nnn 表示オプション更新関数
      function updateDisplayOptions() {
        displayBtns.forEach(btn => {
          const target = btn.getAttribute('data-target');
          const isActive = btn.classList.contains('is-checked');
          if (target === 'index') {
            isActive ? grid.classList.add('show-index') : grid.classList.remove('show-index');
          }
          if (target === 'image') {
            isActive ? grid.classList.remove('hide-cover') : grid.classList.add('hide-cover');
          }
          if (target === 'title') {
            isActive ? grid.classList.remove('hide-title') : grid.classList.add('hide-title');
          }
          if (target === 'tag') {
            isActive ? grid.classList.add('show-tags') : grid.classList.remove('show-tags');
          }
          if (target === 'year') {
             isActive ? grid.classList.add('show-year') : grid.classList.remove('show-year');
          }
        });
      }

      //nnn 表示オプションクリック処理
      displayBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('is-checked');
          updateDisplayOptions();
        });
      });

      updateDisplayOptions();

      //nnn ソートボタン制御
      const sortBtns = document.querySelectorAll('.sort-btn[data-sort]');

      sortBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const sortType = btn.getAttribute('data-sort');
          let currentDir = btn.getAttribute('data-dir');
          let nextDir = 'asc';

          if (currentDir === 'asc') {
            nextDir = 'desc';
          } else if (currentDir === 'desc') {
            nextDir = 'asc';
          }
          
          sortBtns.forEach(otherBtn => {
            if (otherBtn !== btn) {
              otherBtn.textContent = '-';
              otherBtn.setAttribute('data-dir', 'default');
            }
          });

          btn.textContent = (nextDir === 'asc') ? '∧' : '∨';
          btn.setAttribute('data-dir', nextDir);

          mixer.sort(`${sortType}:${nextDir}`);
        });
      });

//nnn Details View ヘッダーソート制御
      const headerSortItems = document.querySelectorAll('.grid-header-row [data-sort]');
      
      headerSortItems.forEach(item => {
        item.addEventListener('click', () => {
          const sortAttr = item.getAttribute('data-sort');
          let currentDir = item.getAttribute('data-dir') || 'default'; // default, asc, desc
          let nextDir = 'asc';

          // 状態の遷移: default/desc -> asc, asc -> desc
          if (currentDir === 'asc') {
            nextDir = 'desc';
          } else {
            nextDir = 'asc';
          }

          // 1. 全てのヘッダーの状態をリセット
          headerSortItems.forEach(el => {
            el.classList.remove('is-active');
            el.setAttribute('data-dir', 'default');
            const arrow = el.querySelector('.sort-arrow');
            if(arrow) arrow.textContent = '';
          });

          // 2. クリックされたヘッダーの状態を更新
          item.classList.add('is-active');
          item.setAttribute('data-dir', nextDir);
          
          // 3. 矢印文字をセット
          const arrowSpan = item.querySelector('.sort-arrow');
          if (arrowSpan) {
            arrowSpan.textContent = (nextDir === 'asc') ? '∧' : '∨';
          }

          // 4. MixItUpにソート命令を送る
          mixer.sort(`${sortAttr}:${nextDir}`);
        });
      });

const dControls = document.querySelectorAll('.d-control');
      dControls.forEach(ctrl => {
        ctrl.addEventListener('click', () => {
          const target = ctrl.dataset.target;
          // 取消線の切り替え
          ctrl.classList.toggle('is-disabled');
          // グリッド全体へのクラス付与（CSSで非表示を制御）
          if (grid) {
            grid.classList.toggle('hide-' + target);
          }
        });
      });

// --- 修正：セッションストレージからタグを読み取ってフィルタを適用 ---
    const initialFilter = sessionStorage.getItem('jumpToTag');

    if (initialFilter) {
      // 1. メモを読み取ったら、すぐに削除する（次回普通に開いたときにフィルタされないようにするため）
      sessionStorage.removeItem('jumpToTag');

      // 2. "all" ボタンのチェックを外す
      const allBtn = filterGroup.querySelector('button[data-filter="all"]');
    if (allBtn) allBtn.classList.remove('is-checked');

    // ".tag-xxxx" が来る前提。保険で先頭に "." が無い場合を吸収してもOKです
    const normalized = initialFilter.startsWith('.') ? initialFilter : `.${initialFilter}`;

    const targetBtn = filterGroup.querySelector(`button[data-filter="${normalized}"]`);
    if (targetBtn) {
      targetBtn.classList.add('is-checked');
    }

}

// 最後にフィルタを適用
applyFilter();
    });
    </script>

  </article>
</main>
{{ end }}
